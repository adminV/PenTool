!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Pen=e()}(this,function(){"use strict";var I={OBJECT_TYPE:{PEN_AUX:"penAux",CIRCLE:"circle",LINE:"line",PATH:"path"},POINT_TYPE:{STRAIGHT:"straight",MIRRORED:"mirrored",DISJOINTED:"disjointed"},CONTROL_TYPE:{LEFT:"handleA",RIGHT:"handleB",MAIN:"main"},PATH_STATE:{NEW:"new"},CURSOR_TYPE:{ADD:"add",NORMAL:"normal",MOVE:"move",CLOSE:"close",DEFAULT:"default"}},e={normal:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAAAXNSR0IArs4c6QAABIdJREFUSA3tVWsspFcY/uaW0dgiOqQimQ3iPmkQtyIShlWEbK0uUlGXdkkbTRBtGlIlQmls2B/qkobBH2JIMFHpBE0YGWwRxqWWBl1WMmu2SnXMfDN9zrQz2c5mN4bd/upJTs533vNevue9UnK5/Obk5GTb8fGxB/VfrIGBgZH4+Hh9dXW1cmxsbHR7e/vGq7TLEIvFEq1WK9RoNFqFQvHn7u6uVUpKypK3t3cPdjuDwdC+zB9gEmVWVlbHg4ODzOTk5J8KCgokGxsbzqWlpfe6urruz8/Pf63X621emlGCsKmpaWtiYuKH7OzsJ+vr66kwwENs77W1tSngbrqhoeHB1NSUCPTrVzXMhsv0REloaGje3Nzcj0D0paen5/chISGfwgCXnECc2tjY+N7w8PANqVQ67+bmVu3i4iK/lHGSNAQhEV5YWCiDW9UymayLGMNmG5VubW3dGhkZkWZlZT3u7+9fNdItPU0KiaCfn19NcXFxIpTfnpmZEep0Oo1EIvk5KCjoY0dHRzFYxENDQ8PIZIGlhoz8hqQxXoh7z8/POUggtqur60N3d3cFPOA3Pj4+CLS2hA8njYxmPI3eKH+R04iQQZiVSmVIUVGRd0lJyUB4ePhtQltZWfm8rKys2sPDoxjXChaLRavVavKjHGyLS+ZfCE9PT/knJyfWNjY2poTw9fX9zsvLS3l0dOQKAxSTydShbo0GCcmixTRmKZHi8/kzQPIIKwkuIwio5eXlPGyera3tQ3InCOH2Sxs0uBRGiS4K56/T09OjdXV17+/s7Mz29PQc19bWCtLS0jYDAwO/ITwE4T8uNYaDkC+8DC4FGpIE1kQqLCwsr7y8/C6bzdaiob+RmZkpi4mJeRc/85i8wyANl7IODg7eRl0OtbS0KJaWlj4kbxdZbCcnJ1VzczOfw+Hcn52dlUKoIjg4+AucZD+zuFwuBbTXampqRCqVyprH47HQhZoWFxdZKKvWZwTMCEx0ko/Quirs7Oz+qKqqyq+vr5+Hgm4g5pvxUug4Cfv7++90dnZyfXx8Xj88PGShZCgkFhcyn0GGZy5jfv87eKCCmbW2tnZndXX1g97e3rdQg09iY2PlUPwViv4XxLa5vb092d7e/jW0PnZlZSUF1xr0ZWRkUGgGNMqpPyoqKt3cyNN3U+ARIxoP35IN4VQY/kQkEkX7+/sLYYTC5LBOTExk9vX1UUgmkw60Qgpu1W1ubuppmlabHp7zYUJo/g7EtkA1jPiGCQQC5tnZGaO1tZV4wsCK2FM5OTkUXEpHRkbuC4XCxoCAgLvmeszvzzWIRi1DUw9OSEhgdXd3U3t7eybZ9PR0Cs1Bh4GtKSwsHI+Ojs6Fhx6ZGCz9AIrr+fn556hBvYODg2kje/UYU/q4uDgayB/AYK6luk0xNBP8zdnZWYlafBN0BmqPwliiMD10GMxq1KkkIiLiDlCpzOQuf8VMFCUlJWlQMgZUKH66o6MDibx26/JaXyAJt15D7JbReXS5ubm/4wc6QTN0oxeIXe0JoykOyTOKgRxzNU3/S79CD/wF1bAnj93p/FEAAAAASUVORK5CYII=",add:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAAAXNSR0IArs4c6QAABUlJREFUSA29VnkspVcU/96ijxrrvFKVUPveILYiGoxJkUqrOihRW6cyTRpLtYpUiaU0JswfxpImtkSIJbFEZayJJZYpYqfMoMOQZxljGct7+ruv/V4673UmGNOb3Nx3zz3n/L7fueec+6j+/v6POzs7C3d2dvSp/2PU1tY2uru7n6ampvJaWlqaFxYWrr9OXEZNTU3TycmJ6/Hx8cnExMSzpaUlaW9v71EjI6NyzCIGg3FymR/AJM6kpaV36urqmF5eXr9HREQ0zczMqMfGxt4pLS29PzQ09PPp6an8pYEShrm5ufMdHR33goODt6enp30AwMXd3iksLJxAuPnZ2dl/dHd3l0Cu+arAbITslDixs7MLGxwc7AKjHw0MDH6ztbX9BgAcsoKxT05OzmcNDQ3XW1tbh3R0dFK1tLT6LwROkoYwJMbDw8MJCOthb29vKQHDZNNO5+fnP21sbGwNCgraqK6unqTl511FDomhubl5enR0tCec3+jr63MVCATHTU1Ns9bW1rdUVFRqoFJTX1/fgEw2PS8QrS9MGnpDwnt0dCSFBGJra2s/0tPTm0AEzNvb2+vAVoHoYeUjoxn/Zk/bn2WlGTKIMo/Hs42KijKKiYmpdXBwuEFk4+Pj3yckJKTq6+tHY5vEYrH4h4eH5EOlMM9dMs8x3Nvb09jd3ZWVl5cXJYSJicmvhoaGvM3NTW0AUEwmU4C6pQGJ6FyDSWcpsdLQ0OgDk8cYHyFkhAE1NjYWhslVUFB4RPaEIcJ+YUBhSAFKfFFY/+zp6WnOzMwMWFxcHCgvL9/JyMgw9fX1nbOysvqF6BCG/4SUvg4iPvMQhhRsSBLIEit7e/uwxMTE22w2+wQN/WpgYGDvtWvXPsHHbJBzAPIRUtbq6ur7qMv6/Pz8idHR0XBydpbBVlNT28rLy9OQkpK6PzAw0AqjJBsbmx+wkikxOBwOBbZX0tPTS7a2tmS5XC4LXSh3ZGSEhbIqkDAQEzDRSb5E60pSVFTcT0lJ+SorK2sIDsrAWENMl0LH8VhZWfmwuLiYY2xsLLe2tsZCyVBILA5svoMNV9xGfP/35UEKZdbU1NTNycnJLyorK99DDW67ubn1w/FPKPoHuNu8oqIiL2VlZRm0PnZycjKF0Ar9+fv7U2gGfJRTtbOzsx98kYRj4RqeiQOKLh6HfBzeJRPGPgD+uqSkxMXCwsIVIBReDllPT09mVVUVhWQS+UErpBBWwdzc3Cmfzz8kB21tbb37+/tXAawDv8JeTRuIGNICeoWyAlg14H7tTU1NmQcHB4yCggISCaEK7p4KCQmhEFK+k5PTiqura46lpeVtcohX5uH29vZbeOIUAPhccxAxpIHoFT20GU3dxsPDg1VWVkYtLy/TR5Sfnx+F5iDo6uo6joyMbHdxcQmF48cihZf8EJaF+DlYaCLlreCIhWwUgeFJotDmqNnZWYG6uvqDtLS0W2DmAfsnsFGlJ/bCyKF01PEP4h0y0UyEZfcihk/gkIdafJsYo/YoPEsUXg8BHuZD1GmTo6PjTbDaQqK9W1FR0Y9u9CaOpchEXTJJQq2vrz+EvXCYmZnxcM8f/CcgHG3jTbyHLvN5XFwcG+2MwlsoCAgImA0PD0/Efx3yVAmHqqrqFs6fampqHtOyjY0NZXSjN3R1dUVhlpGR2ZeTk+PROhIrwnMFdzeGziMIDQ19ig8ohkwYFgllMQFJGtTzHvQlCEkIaFuw3MXT9G18fHwkGGXjbwXpQq88XghIPKMcWrCQeWnjpYAXRSElg0Qj9ScQ9/FaAJWUlILRKLi4FgnAvwBe6YatAEV1yQAAAABJRU5ErkJggg==",close:"data:image/png;base64,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",move:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAAAXNSR0IArs4c6QAAAstJREFUSA3Nld9rklEYx+cMBX/QTaIIKjkYbqibiOAfINJNNxt6E8KIjIVEUBRBRHTRv2Ajhxde7c4LyboJvIguYhqDyS4G2RxqTRvOWkaSp+/zsgOv+r7h/BEdODzvec7zfT7vec9zzjvDGHN1Op3gzL9qAF7LZrOHjUbjGZ5np84FJOL3+38GAoGjg4ODlxhfmioUgDWfz9cGhBmNxl/5fP49fP6pQZH8utfr/UFA6kqlkiUSid1Wq3VvKlAAb3g8nlMO5DYcDpdrtdoW5vUTBSPhzaWlpe8cJLZ2u/10b2/vLWKcE4Mi2S2n0/lNDBI/q9Vqlk6nP7Tb7bWJQAGMLS4utsQQqedYLLZfr9dfIF49FhgJbjscjhMpSL/P7XYfl0qlN9BcHhkK8Z35+flmf3K5sV6v/53L5ejoXB0JCuHdubm5YzkA9ysUCmYwGJjL5WLBYJAVi8UvuBLvnxd6AYLZbrdLZ7CnRaPRLs5nU6PRnOh0OupNQA9RRPtWq3XXZrN9hOATF+HFtXi+gv4acXTMpBsCH0DcwKxw8Mmur6934/H4c2nFoBc5LpbL5e2VlRVGlsaDUWceTD60WCx1DAVgJBJhGxsbW7KCvgkOW1hYEPRk/wqF4JHZbD4iIL3h5ubmq76cskOCVavVbdxUjM4r5SBLY/LT/IAYzscmk+kzFUIymXw3ECDj4DBYoVUqFQFIljdJKCaf4N78mkqldpBbIZO/xw2NsGfLy8s8N5MC0koHPi8UTzOZzE4oFFL2ZJUZIF5LSWivVCqVACJYoVAQVkiWxtTp84r2lKoYH50xI/rQf3rErtJek3TYTvGkI965G4TCCnH/jrbCcxMhAFTYQ9oj3obew1GApCHoWRUKTCmgZJWOChRDaaVUQPQeZKl6Jw7jL0orpaqlPSWgqCoHDz0XjWs5dKi7dFwY1wOqRV8ly33/hf0D+qqSk3G9oaMAAAAASUVORK5CYII="},t=function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t};function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function h(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};y(this,s),this.penType=I.OBJECT_TYPE.PEN_AUX,this.stroke="#ff56b1",this.fill="#006cff",this.lineWidth=1,this.penType=I.OBJECT_TYPE.PEN_AUX,this.stroke=t.stroke||"#ff56b1",this.fill=t.fill||"#006cff",this.lineWidth=t.lineWidth||1}var P=(o(a,s),a);function a(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};y(this,a);var e=n(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,t));return e.radius=3,e.stroke="#006cff",e.fill="#fff",e.x=t.x,e.y=t.y,e.radius=t.radius||3,e.keyPointIndex=t.keyPointIndex,e.handleName=t.handleName,e.fill=t.fill||"#fff",e.stroke=t.stroke||"#006cff",e.type=I.OBJECT_TYPE.CIRCLE,e}var l=(o(r,s),r);function r(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};y(this,r);var e=n(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return e.x1=t.x1,e.y1=t.y1,e.x2=t.x2,e.y2=t.y2,e.type=I.OBJECT_TYPE.LINE,e}function c(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=t.type,n=t.point,i=t.pointType,o=t.relationPoints,s=t.keyPointIndex,a=t.controller1,r=t.controller2,h=t.auxLine1,l=t.auxLine2,P=t.handleName;y(this,c),this.pointType=I.POINT_TYPE.STRAIGHT,this.type=e,this.point=n,this.pointType=i||I.POINT_TYPE.STRAIGHT,this.relationPoints=o||[],this.keyPointIndex=s,this.controller1=a,this.controller2=r,this.auxLine1=h,this.auxLine2=l,this.handleName=P}function T(t,e){y(this,T),this.penModeOn=!1,this.keyPointData=[],this.keyPointDataCache=[],this.closeState=!1,this.cacheCloseState=!1,this.penMouseDown=!1,this.options={circle:new P,line:new l,pathColor:"#000",pathFillColor:"#ebebeb",isFillPath:!1},this.objects=[],this.isEdit=!1;try{t&&(this.canvas=document.getElementById(t),this.canvasCtx=this.canvas.getContext("2d"),this.options=Object.assign({circle:new P,line:new l,pathColor:"#000",pathFillColor:"#ebebeb"},e),this._mouseDown(),this._mouseMove(),this._mouseUp(),this._keydown(),this._mouseDblclick())}catch(t){}}return t(T,[{key:"enablePen",value:function(){this.penModeOn=!0,this.setCursor(I.CURSOR_TYPE.NORMAL)}},{key:"existPenMode",value:function(){var t;null!=this.currentKeyPointIndex?(this.currentKeyPointIndex=null,this.isEdit=!0,this.setCursor(I.CURSOR_TYPE.NORMAL),this.refreshEditPath()):(this.penModeOn=!1,this.pathRealObject&&(t=this.objects.filter(function(t){return t.penType===I.OBJECT_TYPE.PEN_AUX}),this.removeObjects.apply(this,h(t))),this.setCursor(I.CURSOR_TYPE.DEFAULT),this.currentKeyPointIndex=null,this.isEdit=!1),this.refreshRender()}},{key:"setCursor",value:function(t){t===I.CURSOR_TYPE.DEFAULT?this.canvas.style.cursor="default":this.canvas.style.cursor="url("+e[t]+"), default"}},{key:"_mouseDown",value:function(){var e=this;this.canvas.addEventListener("mousedown",function(t){e.penModeOn&&e._penMouseDown(t)})}},{key:"_mouseMove",value:function(){var e=this;this.canvas.addEventListener("mousemove",function(t){e.penModeOn&&(e.penMouseDown&&e.setCursor(I.CURSOR_TYPE.MOVE),e._penMouseMove(t))})}},{key:"_mouseUp",value:function(){var e=this;this.canvas.addEventListener("mouseup",function(t){e.penModeOn&&(e.setCursor(I.CURSOR_TYPE.NORMAL),e._penMouseUp(t))})}},{key:"_mouseDblclick",value:function(){var o=this;this.canvas.addEventListener("dblclick",function(t){var e,n,i;o.penModeOn?(e=o._getMouseOverTarget(t))&&e.penType===I.OBJECT_TYPE.PEN_AUX&&null==e.handleName&&(o.changeKeyPointType(e),o.refreshRender()):(n={x:t.offsetX,y:t.offsetY},i=new Path2D(o.realPathStr),o.canvasCtx.isPointInPath(i,n.x,n.y)&&(o.setCursor(I.CURSOR_TYPE.NORMAL),o.generateEditablePath()))})}},{key:"_keydown",value:function(){var e=this;this.canvas.setAttribute("tabIndex","0"),this.canvas.addEventListener("keydown",function(t){e.penModeOn&&27===t.keyCode&&e.existPenMode()})}},{key:"_penMouseDown",value:function(t){var e,n,i,o,s,a,r=this._getMouseOverTarget(t),h=t.offsetX,l=t.offsetY;if(this.penMouseDown=!0,this.mousedownTarget=r,this.keyPointDataCache=null,this.penMouseMoveFix={x:h,y:l},this._matchObjectsByProrerty("penType",I.OBJECT_TYPE.PEN_AUX,function(t){t.fill="#fff"}),null!==r&&r.penType===I.OBJECT_TYPE.PEN_AUX)return e=r.keyPointIndex,r.fill=r.stroke,1<this.keyPointData.length&&this.currentKeyPointIndex===this.keyPointData.length-1&&0===e&&(this.closeState=!0),!this.closeState&&e===this.keyPointData.length-1||(this.isEdit=!0),this.currentKeyPointIndex=e,this.setMousedownOrigin(),void this.refreshEditPath();0===this.keyPointData.length||this.currentKeyPointIndex===this.keyPointData.length-1&&!this.closeState?(s=void 0,s=0===this.keyPointData.length?new c({type:"M",point:{x:h,y:l},pointType:I.POINT_TYPE.STRAIGHT,relationPoints:[h,l],keyPointIndex:this.keyPointData.length}):(i=(n=this.keyPointData[this.keyPointData.length-1]).point.x,o=n.point.y,n.pointType!==I.POINT_TYPE.STRAIGHT&&(i=n.controller2.x,o=n.controller2.y),new c({type:"C",point:{x:h,y:l},pointType:I.POINT_TYPE.STRAIGHT,relationPoints:[i,o,h,l,h,l],keyPointIndex:this.keyPointData.length})),a=new P({x:h,y:l,keyPointIndex:s.keyPointIndex,fill:this.options.circle.fill,stroke:this.options.circle.stroke}),this.addCanvasObjects(a),this.keyPointData.push(s),this.currentKeyPointIndex=this.keyPointData.length-1,this.refreshEditPath(),this.keyPointState=I.PATH_STATE.NEW):null==this.currentKeyPointIndex?this.existPenMode():0<this.keyPointData.length&&(this.closeState||this.currentKeyPointIndex!==this.keyPointData.length-1)&&(this.currentKeyPointIndex=null,this.isEdit=!0),this.refreshRender()}},{key:"_penMouseMove",value:function(t){var e,n,i,o,s,a=t.offsetX,r=t.offsetY,h=this._getMouseOverTarget(t);this.isEdit?null!=this.mousedownTarget&&this.mousedownTarget.penType===I.OBJECT_TYPE.PEN_AUX&&this.penMouseDown&&((e=this.mousedownTarget).x=a,e.y=r,e.handleName===I.CONTROL_TYPE.LEFT?(t.altKey?this.changeKeyPointType(e,I.POINT_TYPE.DISJOINTED):this.changeKeyPointType(e),this.changeKeyPointPos(a,r,I.CONTROL_TYPE.LEFT)):e.handleName===I.CONTROL_TYPE.RIGHT?(t.altKey?this.changeKeyPointType(e,I.POINT_TYPE.DISJOINTED):this.changeKeyPointType(e),this.changeKeyPointPos(a,r,I.CONTROL_TYPE.RIGHT)):this.changeKeyPointPos(a,r,I.CONTROL_TYPE.MAIN)):this.keyPointState===I.PATH_STATE.NEW?(2<Math.abs(this.penMouseMoveFix.x-a)||2<Math.abs(this.penMouseMoveFix.y-r))&&this.changeKeyPointPos(a,r,I.CONTROL_TYPE.RIGHT):null!=h&&h.penType===I.OBJECT_TYPE.PEN_AUX&&(0!==h.keyPointIndex||this.closeState||0===h.keyPointIndex&&this.currentKeyPointIndex!==this.keyPointData.length-1)?this.penMouseDown||this.setCursor(I.CURSOR_TYPE.MOVE):(this.setCursor(I.CURSOR_TYPE.NORMAL),this.currentKeyPointIndex!==this.keyPointData.length-1||this.closeState||(n=void 0,i=this.keyPointData[this.currentKeyPointIndex],s=o=void 0,null==this.keyPointDataCache?(this.keyPointDataCache=JSON.parse(JSON.stringify(this.keyPointData)),this.keyPointDataCache.push(new c)):this.cacheCloseState=!1,s="M"===this.keyPointData[this.currentKeyPointIndex].type?(o=i.relationPoints[0],i.relationPoints[1]):(o=i.relationPoints[4],i.relationPoints[5]),i.pointType!==I.POINT_TYPE.STRAIGHT&&(o=i.controller2.x,s=i.controller2.y),n=new c({type:"C",point:{x:a,y:r},pointType:I.POINT_TYPE.STRAIGHT,relationPoints:[o,s,a,r,a,r],keyPointIndex:this.keyPointDataCache.length-1}),this.keyPointDataCache[this.keyPointDataCache.length-1]=n,1<this.keyPointData.length&&null!==h&&h.penType===I.OBJECT_TYPE.PEN_AUX&&0===h.keyPointIndex?(this.cacheCloseState=!0,this.setCursor(I.CURSOR_TYPE.CLOSE)):this.setCursor(I.CURSOR_TYPE.ADD),this.refreshEditPath(!0))),this.refreshRender()}},{key:"_penMouseUp",value:function(t){var e=this;this.penMouseDown=!1,this.currentKeyPointIndex===this.keyPointData.length-1&&!this.closeState&&this.penMouseMoveFix&&t.offsetX===this.penMouseMoveFix.x&&t.offsetY===this.penMouseMoveFix.y&&(this.isEdit=!1),this._matchObjectsByProrerty("penType",I.OBJECT_TYPE.PEN_AUX,function(t){t.keyPointIndex===e.currentKeyPointIndex&&null==t.handleName&&(t.fill=t.stroke)}),this.keyPointState=null,this.penMouseMoveFix=null,this.penMouseDownOrigin=null,this.refreshRender()}},{key:"changeKeyPointPos",value:function(t,e,n){var i,o,s,a,r,h,l,P,y,c,T,u,p,d,x,A,E,f,O=2<arguments.length&&void 0!==n?n:I.CONTROL_TYPE.MAIN,v=this.currentKeyPointIndex,k=this.keyPointData[v],C=k.point;O!==I.CONTROL_TYPE.LEFT&&O!==I.CONTROL_TYPE.RIGHT||k.pointType!=I.POINT_TYPE.STRAIGHT||this.createPathCurveAux(k),O===I.CONTROL_TYPE.MAIN?(h=r=a=s=o=i=void 0,this.penMouseDownOrigin&&(this.penMouseDownOrigin.x&&(r=this.penMouseDownOrigin.x-t,h=this.penMouseDownOrigin.y-e),this.penMouseDownOrigin.x1&&(i=this.penMouseDownOrigin.x1-r,s=this.penMouseDownOrigin.y1-h),this.penMouseDownOrigin.x2&&(o=this.penMouseDownOrigin.x2-r,a=this.penMouseDownOrigin.y2-h),this.updatePenPathControll(k,{x:t,y:e,x1:i,y1:s,x2:o,y2:a})),C.x=t,C.y=e,"M"===k.type?(k.relationPoints[0]=t,k.relationPoints[1]=e,v+1<=this.keyPointData.length-1&&(l=this.keyPointData[v+1],k.pointType!=I.POINT_TYPE.STRAIGHT?(l.relationPoints[0]=o,l.relationPoints[1]=a):(l.relationPoints[0]=t,l.relationPoints[1]=e)),k.pointType!=I.POINT_TYPE.STRAIGHT&&(k.relationPoints[2]=i,k.relationPoints[3]=s)):(k.pointType!=I.POINT_TYPE.STRAIGHT?(k.relationPoints[2]=i,k.relationPoints[3]=s):(k.relationPoints[2]=t,k.relationPoints[3]=e),k.relationPoints[4]=t,k.relationPoints[5]=e,v+1<=this.keyPointData.length-1&&(P=this.keyPointData[v+1],k.pointType!=I.POINT_TYPE.STRAIGHT?(P.relationPoints[0]=o,P.relationPoints[1]=a):(P.relationPoints[0]=t,P.relationPoints[1]=e))),k.point={x:t,y:e}):O!==I.CONTROL_TYPE.LEFT&&O!==I.CONTROL_TYPE.RIGHT||(k.pointType==I.POINT_TYPE.STRAIGHT&&(k.pointType=I.POINT_TYPE.MIRRORED),f=E=c=y=void 0,T=k.relationPoints[4],u=k.relationPoints[5],"M"==k.type&&(T=k.relationPoints[0],u=k.relationPoints[1]),k.pointType==I.POINT_TYPE.MIRRORED?(O===I.CONTROL_TYPE.RIGHT?(y=2*T-t,c=2*u-e,E=t,f=e):(E=2*T-t,f=2*u-e,y=t,c=e),this.updatePenPathControll(k,{x:T,y:u,x1:y,y1:c,x2:E,y2:f}),"M"===k.type?(v+1<=this.keyPointData.length-1&&((p=this.keyPointData[v+1]).relationPoints[0]=E,p.relationPoints[1]=f),k.pointType!=I.POINT_TYPE.STRAIGHT&&(k.relationPoints[2]=y,k.relationPoints[3]=c)):(k.relationPoints[2]=y,k.relationPoints[3]=c,v+1<=this.keyPointData.length-1&&((d=this.keyPointData[v+1]).relationPoints[0]=E,d.relationPoints[1]=f))):k.pointType==I.POINT_TYPE.DISJOINTED&&(O===I.CONTROL_TYPE.RIGHT?(E=t,f=e,this.updatePenPathControll(k,{x:T,y:u,x2:E,y2:f},I.CONTROL_TYPE.RIGHT),"M"===k.type?v+1<=this.keyPointData.length-1&&((x=this.keyPointData[v+1]).relationPoints[0]=E,x.relationPoints[1]=f):v+1<=this.keyPointData.length-1&&((A=this.keyPointData[v+1]).relationPoints[0]=E,A.relationPoints[1]=f)):(y=t,c=e,this.updatePenPathControll(k,{x:T,y:u,x1:y,y1:c},I.CONTROL_TYPE.LEFT),"M"===k.type&&"straight"==k.pointType||(k.relationPoints[2]=y,k.relationPoints[3]=c)))),this.refreshEditPath()}},{key:"createPathCurveAux",value:function(t){var e=t.point,n=e.x,i=e.y,o=new P({x:n,y:i,handleName:I.CONTROL_TYPE.LEFT,keyPointIndex:t.keyPointIndex,fill:this.options.circle.fill,stroke:this.options.circle.stroke,lineWidth:this.options.circle.lineWidth}),s=new P({x:n,y:i,handleName:I.CONTROL_TYPE.RIGHT,keyPointIndex:t.keyPointIndex,fill:this.options.circle.fill,stroke:this.options.circle.stroke,lineWidth:this.options.circle.lineWidth}),a=new l({x1:n,y1:i,x2:n,y2:i,stroke:this.options.line.stroke,lineWidth:this.options.line.lineWidth}),r=new l({x1:n,y1:i,x2:n,y2:i,stroke:this.options.line.stroke,lineWidth:this.options.line.lineWidth});t.controller1=o,t.controller2=s,t.auxLine1=a,t.auxLine2=r,this.addCanvasObjects(o,s,a,r)}},{key:"updatePenPathControll",value:function(t,e,n){var i=e.x,o=e.y,s=e.x1,a=e.y1,r=e.x2,h=e.y2,l=Object.assign({},t),P=l.controller1,y=l.controller2,c=l.auxLine1,T=l.auxLine2;null!=n&&n!==I.CONTROL_TYPE.LEFT||(null!=P&&(P.x=s,P.y=a),null!=c&&(c.x1=s,c.y1=a,c.x2=i,c.y2=o)),null!=n&&n!==I.CONTROL_TYPE.RIGHT||(null!=y&&(y.x=r,y.y=h),null!=T&&(T.x1=r,T.y1=h,T.x2=i,T.y2=o))}},{key:"setMousedownOrigin",value:function(){var t=this.keyPointData[this.currentKeyPointIndex],e=t.controller1,n=t.controller2,i=t.point,o={};null!=e&&(o.x1=e.x,o.y1=e.y),null!=e&&(o.x2=n.x,o.y2=n.y),null!=i&&(o.x=i.x,o.y=i.y),this.penMouseDownOrigin=o}},{key:"refreshEditPath",value:function(t){var e,n,i,o,s=0<arguments.length&&void 0!==t&&t,a=this.keyPointData,r=this.closeState;0!==a.length&&(s&&(a=this.keyPointDataCache,r=this.cacheCloseState),n=null,i=e=this._generatePathStr(a),r&&(n=this.options.pathFillColor,i+=" Z"),null!=this.realPathStr&&this.realPathStr===e&&s||(this.realPathStr=i,o=this.objects.filter(function(t){return t.type===I.OBJECT_TYPE.PATH}),this.removeObjects.apply(this,h(o)),this.pathRealObject={pathStr:this.realPathStr,type:I.OBJECT_TYPE.PATH,fill:n||"#ebebeb",closeState:r,index:-1/0},this.addCanvasObjects(this.pathRealObject)))}},{key:"_generatePathStr",value:function(t){var e,n,i="";return t.forEach(function(t){var e,n="";"M"===t.type?(e="M "+t.relationPoints[0]+" "+t.relationPoints[1]+" ",n+=e):"C"===t.type&&(n+="C ",t.relationPoints.forEach(function(t){n+=t+" "})),i+=n}),this.closeState&&(e=t[0],n=t[t.length-1],i+="C ",n.pointType!==I.POINT_TYPE.STRAIGHT?i+=n.controller2.x+" "+n.controller2.y+" ":i+=n.relationPoints[4]+" "+n.relationPoints[5]+" ",e.pointType!==I.POINT_TYPE.STRAIGHT?i+=e.relationPoints[2]+" "+e.relationPoints[3]+" ":i+=e.relationPoints[0]+" "+e.relationPoints[1]+" ",i+=e.relationPoints[0]+" "+e.relationPoints[1]+" "),i}},{key:"refreshRender",value:function(){var e=this;this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this._matchObjectsByProrerty("penType",I.OBJECT_TYPE.PEN_AUX,function(t){t.type===I.OBJECT_TYPE.CIRCLE&&e._bringToFront(t)}),this.drawObjects(this.objects||[])}},{key:"drawObjects",value:function(t){var e=this;t.forEach(function(t){switch(t.type){case I.OBJECT_TYPE.CIRCLE:e.drawCircle(t);break;case I.OBJECT_TYPE.LINE:e.drawLine(t);break;case I.OBJECT_TYPE.PATH:e.drawPath(t)}})}},{key:"drawCircle",value:function(t){this.canvasCtx.fillStyle=t.fill,this.canvasCtx.strokeStyle=t.stroke,this.canvasCtx.beginPath(),this.canvasCtx.arc(t.x,t.y,t.radius,0,2*Math.PI),this.canvasCtx.fill(),this.canvasCtx.stroke()}},{key:"drawPath",value:function(t){this.canvasCtx.fillStyle=this.options.pathFillColor,this.canvasCtx.strokeStyle=this.options.pathColor,this.canvasCtx.beginPath();var e=new Path2D(this.realPathStr);this.canvasCtx.stroke(e),t.closeState&&(!this.keyPointDataCache&&this.options.isFillPath||this.keyPointDataCache&&this.keyPointData.length!==this.keyPointDataCache.length)&&this.canvasCtx.fill(e)}},{key:"drawLine",value:function(t){this.canvasCtx.fillStyle=t.fill,this.canvasCtx.strokeStyle=t.stroke,this.canvasCtx.beginPath(),this.canvasCtx.moveTo(t.x1,t.y1),this.canvasCtx.lineTo(t.x2,t.y2),this.canvasCtx.stroke()}},{key:"addCanvasObjects",value:function(){for(var e=this,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];return n.forEach(function(t){null==t.index&&(t.index=e.objects.length),e.objects.push(t)}),n}},{key:"removeObjects",value:function(){for(var e=this,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];n.forEach(function(t){e.removeSingleObject(t)})}},{key:"removeSingleObject",value:function(t){for(var e=this.objects.length-1;0<=e;e--)if(this.objects[e]===t){this.objects.splice(e,1);break}}},{key:"_getMouseOverTarget",value:function(t){var e={x:t.offsetX,y:t.offsetY},n=null;this.objects.sort(function(t,e){return t-e});for(var i=this.objects.length-1;0<=i;i--){var o=this.objects[i];if(this._containsPoint(e,o)){n=o;break}}return n}},{key:"_containsPoint",value:function(t,e){if(!e.type)return!1;if(e.type===I.OBJECT_TYPE.CIRCLE){var n=e.radius,i=e.x,o=e.y;return t.x<=i+n&&t.x>=i-n&&t.y<=o+n&&t.y>=o-n}if(e.type===I.OBJECT_TYPE.LINE)return(e.y1-e.y2)/(e.x1-e.x2)==(t.y-e.y1)/(t.x-e.x1)&&(t.x>=e.x1&&t.x<=e.x2&&t.y>=e.y1&&t.y<=e.y2||t.x>=e.x2&&t.x<=e.x1&&t.y>=e.y2&&t.y<=e.y1);if(e.type!==I.OBJECT_TYPE.PATH)return!1;var s=new Path2D(e.pathStr);return this.canvasCtx.isPointInStroke(s,t.x,t.y)}},{key:"_matchObjectsByProrerty",value:function(e,n,i){this.objects.forEach(function(t){t[e]===n&&i(t)})}},{key:"_bringToFront",value:function(t){t.index=1/0,this.objects.sort(function(t,e){return t.index-e.index}),this.objects.forEach(function(t,e){t.index=e})}},{key:"changeKeyPointType",value:function(t,e){var n,i,o,s,a,r,h,l,P,y,c,T,u,p,d,x,A,E,f=t.keyPointIndex,O=this.keyPointData[f],v=Object.assign({},I.POINT_TYPE);null==e||O.pointType===I.POINT_TYPE.STRAIGHT&&e in v||e===I.POINT_TYPE.STRAIGHT&&O.pointType in v?(null==O.controller1?(this.createPathCurveAux(O),O.pointType=e||I.POINT_TYPE.MIRRORED,d=u=p=T=c=y=P=l=h=r=a=s=o=i=void 0,i=0===t.keyPointIndex?this.keyPointData[this.keyPointData.length-1]:this.keyPointData[t.keyPointIndex-1],o=t.keyPointIndex===this.keyPointData.length-1?this.keyPointData[0]:this.keyPointData[t.keyPointIndex+1],s=i.point.x,a=i.point.y,r=o.point.x,h=o.point.y,l=O.point.x,P=O.point.y,y=Math.atan2(h-a,r-s),c=Math.sqrt(Math.pow(r-s,2)+Math.pow(h-a,2))/2,T=Math.round(l-c*Math.cos(y)),u=Math.round(P-c*Math.sin(y)),p=Math.round(l+c*Math.cos(y)),d=Math.round(P+c*Math.sin(y)),this.updatePenPathControll(O,{x:l,y:P,x1:T,y1:u,x2:p,y2:d}),f+1<=this.keyPointData.length-1&&((n=this.keyPointData[f+1]).relationPoints[0]=p,n.relationPoints[1]=d),O.relationPoints[2]=T,O.relationPoints[3]=u):(this.removeObjects(O.controller1,O.controller2,O.auxLine1,O.auxLine2),delete O.controller1,delete O.controller2,delete O.auxLine1,delete O.auxLine2,O.pointType=I.POINT_TYPE.STRAIGHT,x=O.point.x,A=O.point.y,"M"===O.pointType?2<O.relationPoints.length&&O.relationPoints.splice(-2,2):(O.relationPoints[2]=x,O.relationPoints[3]=A),f+1<=this.keyPointData.length-1&&((E=this.keyPointData[f+1]).relationPoints[0]=x,E.relationPoints[1]=A)),this.refreshEditPath()):O.pointType=e}},{key:"generateEditablePath",value:function(){this.penModeOn=!0,this.objects=[],this.generateAuxPointLine(this.keyPointData),this.refreshEditPath(),this.refreshRender()}},{key:"generateAuxPointLine",value:function(t){var s=this,e=0<arguments.length&&void 0!==t?t:[];0!==e.length&&e.forEach(function(t,e){var n=t.point.x,i=t.point.y,o=new P({x:n,y:i,keyPointIndex:t.keyPointIndex,fill:s.options.circle.fill,stroke:s.options.circle.stroke});s.addCanvasObjects(o),t.pointType!==I.POINT_TYPE.STRAIGHT&&s.addCanvasObjects(t.auxLine1,t.auxLine2,t.controller1,t.controller2)})}}]),T});